{% extends "index.html" %}
{% block main %}

<head>
<script src="{{ url_for('static', filename='/js/socket.io.js') }}"></script>

<style>
#adminMembers {
    padding: 8px;
    margin: 10px 0;
    border-radius: 6px;
    background: #222;
    color: #fff;
    font-size: 14px;
    display: none;
    white-space: pre-wrap;
}

#kickControls {
    padding: 8px;
    margin: 10px 0;
    border-radius: 6px;
    background: #f0f0f0;
    display: none;
}

#kickControls button {
    margin: 2px;
    padding: 4px 8px;
    background: #ff4d4d;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

#kickControls button:hover {
    background: #cc0000;
}
</style>

<script>
const USERNAME = "{{ username }}";
const IS_ADMIN = {{ 'true' if is_admin else 'false' | tojson }}; // Use tojson for safe output
// fullscreen (mobile only)
function isMobile() {
    return /Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
}
function goFull() {
    if (!isMobile()) return;
    let e = document.documentElement;
    if (!document.fullscreenElement) e.requestFullscreen?.();
}
if (isMobile()) {
    document.addEventListener("click", goFull);
    document.addEventListener("touchstart", goFull);
}
</script>

<audio id="notifySound" src="{{ url_for('static', filename='sounds/notify.mp3') }}"></audio>
</head>

<!-- admin members list -->
<div id="adminMembers"></div>

<!-- kick controls for admin -->
<div id="kickControls">
    <strong>Admin Controls:</strong>
    <button onclick="kickAll()">Kick All</button>
    <div id="memberButtons"></div>
</div>

<div class="message-box">
    <h2>Chat Room: {{ code }}</h2>

    <div class="messages" id="messages"></div>

    <div class="inputs">
        <input id="message" type="text" placeholder="Message" autocomplete="off">
        <button id="send-btn" onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
var socketio = io();
const messagesDiv = document.getElementById("messages");
const adminBox = document.getElementById("adminMembers");
const kickControls = document.getElementById("kickControls");
const memberButtons = document.getElementById("memberButtons");

// show admin sections only for admin
if (IS_ADMIN) {
    adminBox.style.display = "block";
    adminBox.innerText = "Members loadingâ€¦";
    kickControls.style.display = "block";
}

// LIVE MEMBER LIST
socketio.on("member_list", (list) => {
    if (IS_ADMIN) {
        adminBox.innerText = "Members:\n" + JSON.stringify(list, null, 2);
        // update kick buttons
        memberButtons.innerHTML = "";
        list.forEach(user => {
            const btn = document.createElement("button");
            btn.innerText = `Kick ${user}`;
            btn.onclick = () => window.location.href = `/kick/{{ code }}/${user}`;
            memberButtons.appendChild(btn);
        });
    }
});

// kick all function
function kickAll() {
    window.location.href = `/kickall/{{ code }}`;
}

// kick events
socketio.on("kicked", () => window.location.href = "/");
socketio.on("kicked_user", (data) => {
    if (USERNAME === data.user) window.location.href = "/";
});

// create message
function createMessage(name, msg) {
    messagesDiv.innerHTML += `
        <div class="text">
            <span><strong>${name}</strong>: ${msg}</span>
            <span class="muted">${new Date().toLocaleString()}</span>
        </div>
    `;
}

// notification mode
let mode = localStorage.getItem("notifyMode") || "sound";
function setMode(m) {
    mode = m;
    localStorage.setItem("notifyMode", m);
}

// sound (HTTP + HTTPS)
function playSound() {
    let snd = document.getElementById("notifySound");
    snd.pause();
    snd.currentTime = 0;
    snd.play().catch(()=>{});  // catch for autoplay policy
}

// incoming message
socketio.on("message", (data) => {
    createMessage(data.name, data.message);

    if (data.name === USERNAME) return;

    if (mode === "sound") playSound();
});

// send
function sendMessage() {
    const message = document.getElementById("message");
    if (message.value.trim() === "") return;

    socketio.emit("message", { data: message.value });
    message.value = "";
}

// enter key
document.getElementById("message").addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
    }
});
</script>

{% for msg in messages %}
<script>
createMessage("{{ msg.name }}", "{{ msg.message }}");
</script>
{% endfor %}

{% endblock %}
